package #pkg

import com.cws.kmemory.FastCollection
import com.cws.kmemory.collections.ByteList
import com.cws.kmemory.collections.BooleanList
import com.cws.kmemory.collections.ShortList
import com.cws.kmemory.collections.IntList
import com.cws.kmemory.collections.LongList
import com.cws.kmemory.collections.FloatList
import com.cws.kmemory.collections.DoubleList

class #TMap(capacity: Int) : FastCollection {

    private val keys = #KList(capacity)
    private val values = #VList(capacity)
    private val used = BooleanList(capacity)

    override val size: Int = keys.size

    override fun release() {
        keys.release()
        values.release()
        used.release()
    }

    override fun clear() {
        keys.clear()
        values.clear()
        used.clear()
    }

    operator fun set(key: #K, value: #V) {
        val id = (key.hashCode() and Int.MAX_VALUE) % keys.size
        keys[id] = key
        values[id] = value
        used[id] = true
    }

    operator fun get(key: #K, default: #V): #V {
        val id = (key.hashCode() and Int.MAX_VALUE) % keys.size
        return if (used[id] && keys[id] == key) values[id] else default
    }

    fun contains(key: #K): Boolean {
        val id = (key.hashCode() and Int.MAX_VALUE) % keys.size
        return used[id] && keys[id] == key
    }

}